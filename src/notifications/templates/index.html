<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Notifications</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
          crossorigin="anonymous">
    <style>
        .toast-container {
            position: absolute;
            top: 36px;
            right: 8px;
            width: 350px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand bg-dark">
    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
        <!-- Notifications Dropdown Menu -->
        <li class="nav-item dropdown show" id="notifications-menu">
            <a class="nav-link" data-toggle="dropdown" href="#"
               aria-expanded="true">
                <span class="badge badge-warning navbar-badge"
                      id="notifications-badge">{{ new_notifications }}</span>
            </a>
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right"
                 style="left: inherit; right: 0px;">
                {% for notification in notifications %}
                    <button onclick="readNotification({{ notification.pk }})"
                            class="dropdown-item{% if not notification.is_read %} bg-warning {% endif %}">
                        <div>{{ notification.header }}</div>
                        <div class="text-muted">{{ notification.text }}</div>
                        <div class="text-muted text-sm ml-auto">{{ notification.datetime }}</div>
                    </button>
                    <div class="dropdown-divider"></div>
                {% endfor %}
                <a href="#" class="dropdown-item dropdown-footer">See All
                    Notifications</a>
            </div>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-widget="control-sidebar" data-slide="true"
               href="#" role="button">
                <i class="fas fa-th-large"></i>
            </a>
        </li>
    </ul>
</nav>
<div class="container">
    <div class="col-md-12">
        <div class="jumbotron">
            <div class="text-center">
                <h2>Welcome to the notification Viewer</h2>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="text-center">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                    Donec imperdiet aliquet lorem, non maximus urna consectetur
                    sit amet. Mauris quam erat, consequat ut felis non, aliquet
                    tincidunt mi. Cras hendrerit purus sit amet purus volutpat
                    facilisis. Aliquam nec tellus at velit ultrices ornare non
                    ac purus. Aliquam non nunc euismod, finibus tellus aliquet,
                    rhoncus magna. Quisque vel consectetur mauris. Nunc vel
                    dolor sapien. Curabitur non risus ac odio vehicula
                    dignissim. In dolor velit, ultricies a suscipit et,
                    convallis vitae mauris. Fusce sed magna nibh. Cras
                    eleifend, odio ut porta ornare, arcu risus feugiat dolor,
                    vitae pulvinar augue nisi vel nunc. Sed fringilla diam
                    tellus, sed aliquet enim tincidunt vitae. Sed dictum
                    rhoncus ligula porta ornare. Phasellus porta volutpat
                    sagittis. <br> <br>

                    Morbi hendrerit sapien quis gravida varius. Etiam id urna
                    id dui euismod lobortis eu quis ex. Pellentesque id dolor
                    pretium, vulputate odio in, mollis nunc. Pellentesque
                    habitant morbi tristique senectus et netus et malesuada
                    fames ac turpis egestas. Sed sed nisl id nisl placerat
                    elementum. Quisque sit amet egestas neque. Cras viverra
                    pharetra nisi id egestas. Morbi ac sagittis odio, et
                    fringilla lectus. Vivamus orci risus, aliquam sit amet
                    velit eget, vestibulum consectetur massa. <br> <br>

                    Sed finibus ex a lacus commodo, nec pretium mi porta. Duis
                    quis iaculis massa. Suspendisse iaculis in dolor et
                    suscipit. Phasellus in sollicitudin diam. Integer vel augue
                    eget elit convallis vestibulum. Praesent pellentesque, quam
                    non maximus bibendum, mauris neque venenatis ligula, eget
                    viverra dui diam lacinia dui. Duis in vestibulum justo. Nam
                    vitae rutrum augue. Vivamus eget feugiat lectus. Aenean id
                    mauris nec lorem imperdiet iaculis. <br> <br>

                    Nulla eu tortor consectetur, elementum tortor sit amet,
                    tempor elit. Phasellus non felis in erat auctor vehicula.
                    Pellentesque laoreet, orci sit amet tempor ultricies, risus
                    nulla pulvinar justo, ut laoreet quam lectus ac ipsum. Cras
                    vestibulum mollis sollicitudin. Morbi elementum mi sit amet
                    ex euismod, hendrerit porta erat feugiat. Sed aliquet orci
                    tristique facilisis sodales. Sed porttitor sodales est ut
                    malesuada. Maecenas tempus tellus sit amet hendrerit
                    rhoncus. Donec dapibus justo sodales tempus iaculis. Mauris
                    eu aliquet ligula. Maecenas maximus ligula eget mi lobortis
                    pretium. <br> <br>

                    Phasellus ipsum nisl, pellentesque eget bibendum non,
                    aliquam vitae purus. Mauris fringilla nulla vel sapien
                    blandit placerat. Nullam ultrices congue orci tempor
                    sodales. Vestibulum leo massa, dictum eu consequat vel,
                    tristique id quam. Praesent fringilla leo sed tincidunt
                    sagittis. Sed condimentum porttitor lorem, eu molestie odio
                    pulvinar dapibus. Nunc interdum viverra mi, ac consectetur
                    tellus sagittis sed. Curabitur placerat ultrices
                    consectetur. Cras sollicitudin nec augue eu malesuada.
                    Aliquam venenatis mi metus, eu accumsan massa mollis vel.
                </div>
            </div>
        </div>
    </div>

</div>
<div class="toast-container">
</div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>

<script>
    toastContainer = $(".toast-container");
    window.onload = function () {
        var loc = window.location
        var wsStart = loc.protocol == "https:" ? "wss://" : "ws://";
        var wsLocation = wsStart + loc.host + loc.pathname;
        socket = new WebSocket(wsLocation);

        socket.onmessage = function (e) {
            console.log("message", e)
            var message = JSON.parse(e.data);
            var type = message.type
            if (type == 'notification') {
                var content = message.content;
                showToast(content.id, content.header, content.body)
                increaseCount()
            } else if (type == 'mustRefresh') {
                refreshNotifications()
            }
        }
        socket.onopen = function (e) {
            console.log("open", e)
        }
        socket.onerror = function (e) {
            console.log("error", e)
        }
        socket.onclose = function (e) {
            console.log("close", e)
        }
    }

    function showToast(id, header, body) {
        var toastStr = "" +
            "<div class=\"toast fade\" role=\"alert\" aria-live=\"assertive\"\n" +
            "     aria-atomic=\"true\" data-delay=\"3000\" id=\"" + id + "\">\n" +
            "    <div class=\"toast-header\">\n" +
            "        <svg class=\"bd-placeholder-img rounded mr-2\" width=\"20\"\n" +
            "             height=\"20\"\n" +
            "             xmlns=\"http://www.w3.org/2000/svg\"\n" +
            "             preserveAspectRatio=\"xMidYMid slice\" focusable=\"false\"\n" +
            "             role=\"img\">\n" +
            "            <rect fill=\"#007aff\" width=\"100%\" height=\"100%\"></rect>\n" +
            "        </svg>\n" +
            "        <strong class=\"mr-auto\">" + header + "</strong>\n" +
            "        <small class=\"text-muted\">just now</small>\n" +
            "        <button type=\"button\" class=\"ml-2 mb-1 close\"\n" +
            "                data-dismiss=\"toast\"\n" +
            "                aria-label=\"Close\">\n" +
            "            <span aria-hidden=\"true\">Ã—</span>\n" +
            "        </button>\n" +
            "    </div>\n" +
            "    <div class=\"toast-body\">\n" +
            "        " + body + "\n" +
            "    </div>\n" +
            "</div>";
        toastContainer.append(toastStr);
        var toast = $('#' + id);
        toast.toast('show');
    }

    function readNotification(id) {
        var data = {
            type: "read",
            content: {
                id: id
            }
        }
        socket.send(JSON.stringify(data));
    }

    function increaseCount() {
        var badge = $('#notifications-badge');
        var val = parseInt(badge.text()) + 1;
        badge.text(val);
    }

    function refreshNotifications() {
        $.ajax({
            url: window.location.href,
            success: function (res) {
                $('#notifications-menu').html($('#notifications-menu', res));
            },
        });
    }
</script>
</body>
</html>